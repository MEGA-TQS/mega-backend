name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - dev 
  pull_request:
    types: [opened, synchronize, reopened] 
    branches:
      - main
      - dev

jobs:
  sonar_analysis:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      # SETUP JDK (Required for Java Build & Bytecode)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      # BUILD PROJECTS (Crucial Prerequisite)
      - name: Build Java Backend
        working-directory: ./MEGA-backend
        run: mvn -B verify
        
      - name: Install & Test Frontend (Generate Coverage Report)
        working-directory: ./MEGA-frontend 
        run:
          npm cache clean --force
          npm install
          npm test -- --coverage --watchAll=false 

      # UNIFIED SONAR SCAN (Using Dedicated Action)
      - name: Analyze Code with SonarCloud Scanner
        uses: SonarSource/sonarcloud-github-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # Arguments passed to the SonarScanner CLI:
          args: >
            -Dsonar.organization=${{ secrets.ORG_KEY }} 
            -Dsonar.projectKey=${{ secrets.PROJ_KEY }} 
            -Dsonar.host.url=https://sonarcloud.io 
            
            -Dsonar.sources=./MEGA-backend/src,./MEGA-frontend/src 
            -Dsonar.tests=./MEGA-backend/src,./MEGA-frontend/src 
            
            -Dsonar.java.binaries=./MEGA-backend/target/classes 
            
            -Dsonar.javascript.lcov.reportPaths=./MEGA-frontend/coverage/lcov.info 
            -Dsonar.test.inclusions=**/*.test.js,**/*.spec.js
